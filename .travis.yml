sudo: false
dist: trusty

language: java

env:
  global:
    - RENAISSANCE_VERSION="0.11.0"
    - RENAISSANCE_SCALA_VERSION="2.12"
    - RENAISSANCE_JAR="target/renaissance-gpl-$RENAISSANCE_VERSION.jar"
    - RENAISSANCE_JMH_JAR="renaissance-jmh/target/scala-$RENAISSANCE_SCALA_VERSION/renaissance-jmh-assembly-$RENAISSANCE_VERSION.jar"
    - BUILD_CACHE_DIR="$HOME/.prebuilt"
    - CACHED_RENAISSANCE_JAR="$BUILD_CACHE_DIR/$(git rev-parse HEAD).jar"
    - CACHED_RENAISSANCE_JMH_JAR="$BUILD_CACHE_DIR/$(git rev-parse HEAD)-jmh-assembly.jar"

refs:
  - &bundle
    stage: bundle
    script:
      # Fail the script if any command fails
      - set -e
      - 'java -version'
      - 'javac -version'
      - ./tools/sbt/bin/sbt assembly
      - ./tools/sbt/bin/sbt renaissanceJmh/jmh:assembly
      # Ensure that the JMH bundle contains non-empty BenchmarkList
      - 'test $(unzip -p "$RENAISSANCE_JMH_JAR" META-INF/BenchmarkList | wc -l) -gt 0'
      # Clear cache directory
      - 'mkdir -p "$BUILD_CACHE_DIR"'
      - 'ls "$BUILD_CACHE_DIR"'
      - 'rm -f "$BUILD_CACHE_DIR"/*.jar'
      # Store bundles in cache directory
      - 'cp --reflink=auto "$RENAISSANCE_JAR" "$CACHED_RENAISSANCE_JAR"'
      - 'cp --reflink=auto "$RENAISSANCE_JMH_JAR" "$CACHED_RENAISSANCE_JMH_JAR"'

  - &bench
    stage: benchmark
    script:
      # Fail the script if any command fails
      - set -e
      # Get bundles from cache or build them
      - mkdir -p $(dirname "$RENAISSANCE_JAR")
      - if [ -e "$CACHED_RENAISSANCE_JAR" ]; then cp --reflink=auto "$CACHED_RENAISSANCE_JAR" "$RENAISSANCE_JAR"; else ./tools/sbt/bin/sbt assembly; fi
      - mkdir -p $(dirname "$RENAISSANCE_JMH_JAR")
      - if [ -e "$CACHED_RENAISSANCE_JMH_JAR" ]; then cp --reflink=auto "$CACHED_RENAISSANCE_JMH_JAR" "$RENAISSANCE_JMH_JAR"; else ./tools/sbt/bin/sbt renaissanceJmh/jmh:assembly; fi
      # Ensure that the JMH bundle contains non-empty BenchmarkList
      - 'test $(unzip -p "$RENAISSANCE_JMH_JAR" META-INF/BenchmarkList | wc -l) -gt 0'
      - 'java -version'
      # Test benchmarks under Renaissance harness
      - 'java -jar "$RENAISSANCE_JAR" --raw-list >list.txt'
      - 'for BENCH in $(cat list.txt); do echo "====> $BENCH"; java -Xms2500M -Xmx2500M -jar "$RENAISSANCE_JAR" -c test -r 1 --csv output.csv --json output.json "$BENCH" || exit 1; done'
      # Test benchmarks under JMH harness
      - 'java -Xms2500M -Xmx2500M -jar "$RENAISSANCE_JMH_JAR" -wi 0 -i 1 -f 1 -foe true'

jobs:
  include:
    - stage: "Basic checks"
      name: "Check style"
      script:
        - ./tools/sbt/bin/sbt renaissanceFormatCheck

    - stage: "Basic checks"
      name: "README.md is up to date"
      script:
        - ./tools/sbt/bin/sbt assembly
        - java -jar "$RENAISSANCE_JAR" --readme && git diff --exit-code -- README.md CONTRIBUTION.md

    - stage: "Basic checks"
      name: "Content encoding of Java sources"
      script:
        - ./tools/check-encoding.sh

    - <<: *bundle
      os: osx
      osx_image: xcode9.3
      jdk: oraclejdk9
    - <<: *bundle
      jdk: openjdk8
    - <<: *bundle
      jdk: oraclejdk8
    - <<: *bundle
      jdk: oraclejdk9
    - <<: *bundle
      env:
       - USE_JDK=openjdk11
    - <<: *bundle
      env:
        - USE_JDK=OpenJ9

    - <<: *bench
      os: osx
      osx_image: xcode9.3
      jdk: oraclejdk9
    - <<: *bench
      jdk: openjdk8
    - <<: *bench
      jdk: oraclejdk8
    - <<: *bench
      jdk: oraclejdk9
    - <<: *bench
      env:
       - USE_JDK=openjdk11
    # Disabled because of #131
    #- <<: *bench
    #  env:
    #    - USE_JDK=OpenJ9

stages:
  - "Basic checks"
  - bundle
  - benchmark

before_script:
  # For us, the default options are broken as they pass "-v"
  # to the JVM instead after the sbt JAR.
  - unset SBT_OPTS
  - "# Install custom JDK if needed"
  - 'if [ -n "$USE_JDK" ]; then wget "https://github.com/sormuras/bach/raw/master/install-jdk.sh" && chmod +x install-jdk.sh; fi'
  - 'if [ -n "$USE_JDK" ]; then export JAVA_HOME="$HOME/$USE_JDK"; fi'
  - 'if [ "$USE_JDK" = "OpenJ9" ]; then ./install-jdk.sh --url "https://api.adoptopenjdk.net/v2/binary/releases/openjdk11?openjdk_impl=openj9&os=linux&arch=x64&release=latest&heap_size=normal&type=jdk" --target "$JAVA_HOME"; fi'
  - 'if [ "$USE_JDK" = "openjdk11" ]; then ./install-jdk.sh -f 11 --target "$JAVA_HOME"; fi'
  - 'if [ -n "$USE_JDK" ]; then export PATH="$JAVA_HOME/bin:$PATH"; fi'

cache:
  directories:
    - $HOME/.ivy2/cache
    - $HOME/.sbt
    - $BUILD_CACHE_DIR

before_cache:
  # Cleanup the cached directories to avoid unnecessary cache updates
  # (see https://www.scala-sbt.org/1.0/docs/Travis-CI-with-sbt.html#Caching)
  - rm -fv $HOME/.ivy2/.sbt.ivy.lock
  - find $HOME/.ivy2/cache -name "ivydata-*.properties" -print -delete
  - find $HOME/.sbt -name "*.lock" -print -delete
